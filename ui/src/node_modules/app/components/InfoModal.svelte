<script>
	import * as _ from 'lamb';
	import {isArray, isObject} from '@svizzle/utils';

	import ExternalLink from './ExternalLink.svelte';

	const noop = () => {};
	const formatDate = _.pipe([
		String,
		s => `${s.slice(0, 4)}-${s.slice(4, 6)}-${s.slice(6, 8)}`
	]);

	const query_types = ['POST', 'Â ElasticSearch', 'Neo4j', 'MySQL'];

	export let api_doc_url;
	export let api_type;
	export let auth_provider;
	export let data_date;
	export let description_long;
	export let endpoint_url;
	export let is_experimental;
	export let is_public;
	export let query;
	export let region;
	export let source_name;
	export let source_url;
	export let url;
	export let warning;
	export let year_extent;

	$: date = data_date && formatDate(data_date);
	$: regionType = region.type.replace('Region', '').toUpperCase();
</script>

<div class='modal' on:click>
	<div
		class='panel'
		on:click|stopPropagation={noop}
	>
		<h2>About the data</h2>
		{#if description_long}
		<p class='longDesc'>{description_long}</p>
		{/if}
		<p>
			<b>Source:</b>
			<ExternalLink href={source_url} text={source_name}/>
		</p>
		{#if api_doc_url}
			<p>
				<b>Source documentation:</b>
				<ExternalLink href={api_doc_url}/>
			</p>
		{/if}
		{#if date}
		<p><b>Data downloaded on date:</b> {date}</p>
		{/if}
		{#if endpoint_url}
			{#if api_type === 'FETCH'}
				{#if isObject(endpoint_url)}
					<p><b>Source data:</b></p>
					<ul>
					{#each _.pairs(endpoint_url) as [year, value]}
						{#if isArray(value)}
						<li>{year}:
							<ul>
							{#each value as href, index}
								<li><span><ExternalLink {href} text='Link {index + 1}'/></span></li>
							{/each}
							</ul>
						</li>
						{:else}
						<li><span><ExternalLink href={value} text={year}/></span></li>
						{/if}
					{/each}
					</ul>
				{:else if isArray(endpoint_url)}
					<p><b>Source data:</b></p>
					<ul>
					{#each endpoint_url as href, index}
						<li><span><ExternalLink {href} text={index + 1}/></span></li>
					{/each}
					</ul>
				{:else}
					<p>
						<b>Source data:</b>
						<ExternalLink href={endpoint_url}/>
					</p>
				{/if}
			{:else if query_types.includes(api_type)}
				<p>
					<b>Endpoint:</b>
					<ExternalLink href={endpoint_url} />
				</p>
				{#if query}
				<p>Query (<b>{api_type}</b>):</p>
				<pre>{query}</pre>
				{/if}
			{/if}
		{/if}
		<p>
			<b>Available years:</b> {year_extent[0]}
			{#if year_extent[0] !== year_extent[1]}
			- {year_extent[1]}
			{/if}
		</p>
		<p>
			<b>Region type:</b>
			<span>{regionType}</span>
			{#if region.level}<span>(level: {region.level})</span>{/if}
		</p>
		{#if url}
			<p>
				<b>Indicator download:</b>
				<ExternalLink href={url}/>
			</p>
		{/if}
		{#if !_.isUndefined(is_public) && !is_public}
			<p>
				<b>Access:</b>
				<span>The dataset originally used to create this indicator is not public. </span>
				{#if auth_provider}
				<span>Please contact {auth_provider} for more details about access.</span>
				{/if}
			</p>
		{/if}
		{#if is_experimental}
			<p>
				Note that this indicator is <b>experimental</b>.
			</p>
		{/if}
		{#if warning}
			<p>
				<b>Warning:</b>
				<span>{warning}</span>
			</p>
		{/if}
	</div>
</div>

<style>
	.modal {
		align-items: center;
		background-color: rgba(255, 255, 255, 0.5);
		display: flex;
		height: 100%;
		justify-content: space-around;
		position: absolute;
		width: 100%;
		cursor: pointer;
	}

	.panel {
		background-color: white;
		border: 1px solid lightgrey;
		box-shadow: var(--box-shadow-xy);
		max-height: 80%;
		max-width: 800px;
		padding: 1rem;
		overflow-y: auto;
		cursor: auto;
	}

	.longDesc {
		margin-bottom: 1rem;
	}

	b {
		font-family: 'Open Sans Regular', sans-serif;
		margin-right: 0.25rem;
	}

	ul {
		margin-left: 1.5rem;
	}
</style>
