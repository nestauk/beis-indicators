<script>
	import { getContext } from 'svelte';
	import * as _ from 'lamb';
	import { linearScale } from 'yootils';

	import { goto } from '@sapper/app';
	import { yearRange } from 'app/data/groups';
	import groups from 'app/data/indicatorsGroups.json';

	const {timelineLayoutStore} = getContext('layout');

	export let height;
	export let width;
	export let availableYears;
	export let selectedYear;
	export let indicatorId;

	$: layout = $timelineLayoutStore;
	$: yearsY = availableYears.length > 0 ? layout.y2 : layout.ym;
</script>

<div
	class="Timeline"
	bind:clientHeight={height}
	bind:clientWidth={width}
>
	{#if width && layout}
	<svg
		{width}
		{height}
	>
		{#if availableYears}
		<g transform='translate(0,{layout.y1})'>
			<line
				x1='{layout.scaleX(availableYears[0]) + layout.radius}'
				x2='{layout.scaleX(_.last(availableYears)) - layout.radius}'
			/>
			{#each availableYears as year}
			<!-- FIXME using <a> in svg seems to give a bad URL hence reloading the page -->
			<!-- <a
				rel='prefetch'
				href='indicators/{indicatorId}/{year}'
			> -->
				<circle
					class:selected='{selectedYear && selectedYear === year}'
					cx='{layout.scaleX(year)}'
					r={layout.radius}
					on:click='{() => goto(`indicators/${indicatorId}/${year}`)}'
				/>
			<!-- </a> -->
			{/each}
		</g>
		{/if}

		{#each yearRange as year}
		<text
			font-size={layout.fontSize}
			x={layout.scaleX(year)}
			y={yearsY}
		>{year}</text>
		{/each}
	</svg>
	{/if}
</div>

<style>
	.Timeline {
		height: 100%;
		width: 100%;
	}

	a {
		text-decoration: none;
	}

	svg text {
		stroke: none;
		fill: var(--color-grey-70);
		dominant-baseline: middle;
		text-anchor: middle;
		pointer-events: none;
	}

	svg line {
		stroke: var(--color-grey-70);
		stroke-width: 0.75;
		pointer-events: none;
	}

	svg circle {
		fill-opacity: 1;
		fill: white;
		stroke: var(--color-grey-70);
		stroke-width: 1.5;
		cursor: pointer;
	}
	svg circle.selected {
		fill: var(--color-main-desat-50);
	}
</style>
